# 第三章 计算机架构



要编写较底层的代码，程序员必须了解计算机的架构。它类似于在软件框架中编写程序时，他必须知道框架会能够解决什么样的问题，以及如何通过其提供的接口来使用框架。



但在了解计算机体系结构的定义之前，我们必须了解计算机究竟是什么，因为许多人仍然认为计算机是我们放在桌面上的常见计算机，或者充其量只是服务器。计算机有各种形状和大小，人们从来不会想到那就是计算机，也不会想到代码可以跑在这样的设备上。





## 3.1 什么是计算机



计算机是一种硬件设备，至少包括处理器（CPU），计算机存储设备和输入/输出接口。所有的计算机都可以分为两种类型



+ 单用途计算机

  单用途计算机是一种为特定任务建立在硬件水平的计算机。举栗子：

  + 单用途：encoder / decoder；时间，图像/视频/音频处理器



+ 通用用途计算机

  通用用途计算机是一种可编程的（不用修改它的硬件）计算机。这种计算机用来模仿各种单用途计算机的功能



### 3.1.1 Server



服务器是一款通用的高性能计算机，具有巨大的服务器资源，可为广大客户提供大规模服务。客户是指那些通过个人设备连接服务器的人。



![](https://upload-images.jianshu.io/upload_images/15548795-b0cce0b1df47242e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 3.1.2 台式计算机



台式计算机是一台通用计算机，具有为人类用户设计的输入和输出系统。具有足够给个人使用的资源。

输入系统通常包括鼠标和键盘，而输出系统通常包括一个可以显示大量像素的显示器。计算机封装在一个底盘中，足以放置各种计算机组件，如处理器，主板，电源，硬盘等。



![](https://upload-images.jianshu.io/upload_images/15548795-d88c1af1812179f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 3.1.3 便携式计算机



便携式计算机类似于具有较少资源移动计算机的台式计算机，但可以随身携带。



![](https://upload-images.jianshu.io/upload_images/15548795-97d1dd2b71325724.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 3.1.4 游戏机



游戏机类似于台式计算机，但针对游戏进行了优化。游戏控制台的输入系统不是键盘和鼠标，而是游戏控制器，它是一个带有几个用于控制屏幕上物体的按钮的设备;输出系统是显示屏。



游戏机使用定制的处理器和图形处理器，但类似于台式计算机。例如，第一台 Xbox 使用定制的 Intel PentiumIII 处理器



![](https://upload-images.jianshu.io/upload_images/15548795-1a7a2304bf0202fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



手持游戏机与游戏机类似，但是手持游戏机把整个输入输出设备和计算机都包在了一起。



![](https://upload-images.jianshu.io/upload_images/15548795-975bf41d19884686.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)





### 嵌入式计算机



嵌入式计算机是单板或单芯片计算机。为整合到大型硬件中设计，只有有限的资源。



*微控制器*是一种嵌入式计算机，用于控制微控制器的其他硬件设备。微控制器安装在芯片上。微控制器是通用计算机，但资源有限，因此它只能执行一项或几项专门任务。这些计算机仅用于一个目的，但它们仍然是通用的，因为它们可以根据需要对它们进行编程以执行不同的任务，而无需更改底层硬件。



![](https://upload-images.jianshu.io/upload_images/15548795-c5f80f20d098f228.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



另一种类型的嵌入式计算机是 system-on-chip。system-on-chip 是单个芯片上的完整计算机。



虽然微控制器也安装在芯片上，但其目的却不同。微控制器通常更简单并且在硬件资源方面更受限制，因为在运行时仅专门用于一个目的。



而 system-on-chip 是可以用于多种目的的通用计算机。system-on-chip 可以像常规台式计算机一样运行，能够加载操作系统并运行各种应用程序。片上系统通常存在于智能手机中，例如在 Ipad2 和iPhone 4S 中使用的 Apple A5 SoC，或在许多 Android 手机中使用的 Qualcomm Snapdragon。



![](https://upload-images.jianshu.io/upload_images/15548795-3f1bdeb958beef87.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



无论是微处理器还是 system-on-chip。他们都需要搭载在一个环境上，以连接其他设备。这种环境是一种电路板叫做 PCB（Printed Circuit Board）



印刷电路板（PCB）包含线能够使电子设备上流动。没有 PCB 也就不能联合所有设备，也就不能创建一个更大的设备。



嵌入式设备，是大型设备的一份子，帮助大型设备在更高层次的完成更高目标。给嵌入式设备写代码就叫做嵌入式编程。嵌入计算机被用来自动控制像电动工具，植入医疗设备，办公设备，引擎控制系统，家电，远程控制系统和其他嵌入式系统。





老实说，微处理器和 system-on-chip 的界限很模糊。如果硬件保持升级，那么微处理器可以得到足够的资源跑一个操作系统，用来处理多个特定的任务。相反，system-on-chip 也有足够的能力胜任微控制器的任务。



然而，把 system-on-chip 当做微控制器真的不是一个性价比很高的选择，而且会浪费很多硬件资源。因为给微控制器写软件会需要一些计算资源。



### 3.1.6  可编程门阵列 （Field－Programmable Gate Array）



可编程门阵列 （FPGA）是一种包含一组可重新定制门的硬件。也就是说，当这个硬件从娘胎里出来以后，它的电路结构还是可编程的。想想之前的章节，每一个 74HC00 芯片可以被当做一个门。一个复杂的设备可以由多个 74HC00 芯片组合成。



相似的是，每一个 FPGA 设备。包含成百上千的芯片，这些芯片叫做逻辑块（logic blocks）。这是一种比 74HC00 复杂的多的芯片，它也可以实现布尔逻辑函数（Boolean logic function）。这些连在一起的逻辑块能够创建高级硬件的功能。这些高级的功能通常是一种需要高速处理的专用算法。



![](https://upload-images.jianshu.io/upload_images/15548795-637076829ce9fe7d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

数字设备可以通过组合逻辑门来设计，不需要管实际的实际的电路部件，因为物理电路只是多个 CMOS 电路。数字硬件，包括计算机中的各种组件，是通过编写代码而设计的，就像常规程序员一样，通过使用语言来描述门是如何连接在一起的。这种语言称为**「硬件描述语言」**（Hardware Description Language）。之后，硬件描述被编译为连接的电子组件的描述 ，被叫做 *netlist*，是一种对门电路更详细的描述。



FPGA 与其他嵌入式计算机之间的区别在于 FPGA 中的程序是在数字逻辑级实现的，而嵌入式计算机中的程序，如微控制器或片上系统设备则是在汇编代码级实现的。为 FPGA 器件编写的算法是对逻辑门中的算法的描述，然后 FPGA 器件遵循描述以将其自身配置为算法。为微控制器编写的算法是汇编指令，处理器可以理解并采取相应的行动。





FPGA 适用于在常规计算机上运行的专用操作，且不适合成本高昂的情况，例如实时医学图像处理，巡航控制系统等等。这些应用程序需要使用常规处理器无法实现的高速处理，因为处理器在执行许多非专用指令（可能会增加数千条指令或更多指令）时浪费了大量时间来实现这样的的操作，因此在完成相同操作的时候需要更多的物理电路。FPGA 设备不能承受这样的开销，相反，它只运行一个直接在硬件中实现专门的操作





### 3.1.7 专用集成电路



一个专用集成电路（Application-Specific Integrated Circuit）是一种用于特定目的而不是用于通用目的的芯片。



ASIC 不包含通用的逻辑块阵列，不能够重新配置以适应任何类似 FPGA 的操作。相反，每一个在 ASIC 的逻辑块都是为自身电路存在的。FPGA 可以被认为是ASIC的原型阶段，而 ASIC 则是电路生产的最后阶段。



ASIC 比 FPGA 更专用，所以它有更高的性能。然而，ASIC 对制造产商来说非常昂贵。一旦被制作出来，只要发生任何设计错误，一切都化为泡沫。这一点不像 FPGA ，FPGA 可以被简单的重新编程。



## 3.2 计算机架构



上一节研究了各类计算机。无论形状和尺寸如何，每台计算机都有它从高层到底层的意义。



`计算机架构 = 指令集架构 + 计算机组成 + 硬件`



最高层是`指令集架构`（ Instruction Set Architecture.）

中层是`计算机组成`（Computer Organization）

最底层是`硬件`（Hardware）





现在分开叙述这些名词是什么意思。



### 3.2.1 指令集架构



`指令集`是微处理器能够理解并可以执行的基本命令集合



`指令集架构`（Instruction Set Architecture）或者叫做 ISA，是实现指令集的环境设计。本质上，ISA 就是一种类似现在高级语言解释器的运行环境。`指令集架构`的设计包括所有的指令，寄存器，中断，内存模型（内存如何被程序使用和安排），地址模型，I/O 等等一些跟 CPU 有关的东西。CPU 有更多的功能，就有需要实现更多的电路。





### 3.2.2 计算机组成

计算机组成是计算机设计的功能视图。计算机组成在这个视图中，计算机的硬件组件呈现为具有输入和输出的盒子，它们相互连接并形成计算机的设计。两台计算机可能具有相同的 ISA，但具有不同的组成。例如，AMD 和 Intel 处理器都实现了x86 ISA，但构成 ISA 环境的每个处理器的硬件组件并不相同。



计算机组成随着产商的设计不同而不同，但是他们有同一个源头冯·诺依曼（Von Neumann architecture）



![](https://upload-images.jianshu.io/upload_images/15548795-0f19367824da777f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

CPU 不断的从主存里面拿到指令并执行。



* *内存*（Memory）可以存储程序和代码

+ *总线*（Bus）是一种在上述组件之间发送 bit 的电线
+ *I/O 设备* （Input and Output）是为计算机提供输入输出的设备



冯诺依曼（Von-Neumann）计算机通过将其指令存储在主存中来操作，并且 CPU 反复将这些指令一个个取出并存入内部存储器中以便执行。数据通过 CPU，存储器和 I/O 设备之间的数据总线传输，存储在设备中的位置由 CPU 通过地址总线传输。这种架构完全实现了*获取 - 解码 - 执行* 的循环。



早期的计算机，完全按*冯诺依曼计算机*来实现的，有 CPU，内存，I/O 设备并在相同的总线中交互。如今，计算机有更多的总线，每一种总线都有它特定的功能。然而，核心来看，他们仍然是冯诺依曼机器。为了写一个冯诺依曼机器的操作系统，程序员必须能够读懂并写出那些能够控制核心组件的代码：CPU、内存、I/O 设备和总线



**CPU**（Central Processing Unit）是任何计算机的核心。理解 CPU 对写一个操作系统非常重要。





+  为了理解这些设备，一个程序员需要控制 CPU 去使用其他设备的编程接口。CPU 就是唯一的办法，因为 CPU 就是程序员能够直接使用的设备，而且是唯一能够理解程序员代码的设备。

  

+ 在 CPU 里面，许多操作系统概念已经直接在硬件中实现，例如任务切换，分页。内核程序员需要知道如何使用硬件功能，以避免在软件中重复这样的概念，从而浪费计算机资源。



+ CPU 内置操作系统功能可提高操作系统性能和开发人员生产力，因为这些功能就是实际的硬件，最底层的东西。程序员当然可以用这些东西。



+ 为了高效的使用 CPU，程序员应该能够读懂来自硬件厂商的文档。比如：`Intel®64 and IA-32 Architectures Software Developer Manuals`



+ 学会一个 CPU 架构，很容易学会其他架构。



 CPU 就是 ISA 的实现，高效的实现汇编语言（可能 CPU 的架构不同，语言可能不同）。汇编语言是软件工程师控制 CPU 的接口，因此控制计算机。



但是，如何只使用 CPU 访问每台计算机的所有设备？简单的答案是 CPU 可以通过这两个接口与其他设备通信，从而命令它们：



+ 寄存器（Registers）

  寄存器是一种能够高速访问的硬件，而且可以和其他应硬件设备交互。寄存器允许软件直接通过写入设备的寄存器来控制硬件，或者从设备的寄存器读取时，获取硬件的信息。

  

  并非所有寄存器都用于与其他设备通信。在 CPU 中，大多数寄存器用作临时数据的高速存储。其他的可以和 CPU 交互的设备，通常有一组给 CPU 交互的寄存器。



+ 端口（Port）

  端口是硬件设备中专用的寄存器，被用来和其他设备交互。当数据被写入一个端口的时候，硬件会根据值的不同做出不同的反应。端口（port）和寄存器（Registers）的最大不同是，寄存器不存储数据，而是将数据委托给其他电路。



这两种接口都非常重要，因为他们是软件操纵硬件的唯二接口。写设备驱动本质上就是学习每个寄存器的功能，以及为了控制硬件如何使用这些寄存器



内存（Memory）是一种存储设备。内存包括很多的单元，每个单元都有它的地址。所以一个 CPU 可以使用这些地址访问内存单元。